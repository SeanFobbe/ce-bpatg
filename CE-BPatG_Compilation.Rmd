---
title: "Compilation Report | Corpus der Entscheidungen des Bundespatentgerichts (CE-BPatG)"
author: Seán Fobbe
geometry: margin=3cm
fontsize: 11pt
output:
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
    pandoc_args: --listings
    includes:
      in_header: reports/Preamble_DE.tex
      before_body: [temp/CE-BPatG_Definitions.tex, tex/CE-BPatG_CompilationTitle.tex]
papersize: a4
---



```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE,
                      comment = "#>")
```




## Packages laden


```{r}

library(targets)
library(tarchetypes)
library(RcppTOML)
library(future)
library(data.table)
library(quanteda)
library(knitr)
library(kableExtra)
library(igraph)
library(ggraph)

tar_unscript()
```


# Todo

- standardize "." and "_"


# Vorbereitung

## Definitionen

```{r}

datestamp <- Sys.Date()
config <- RcppTOML::parseTOML("CE-BPatG_Config.toml")
dir.analysis <- paste0(getwd(),
                       "/analysis")


```


## Aufräumen

Löscht Dateien im Output-Ordner, die nicht vom heutigen Tag sind.


```{r}

unlink(grep(datestamp,
            list.files("output",
                       full.names = TRUE),
            invert = TRUE,
            value = TRUE))

```



## Ordner erstellen

```{r}

#unlink("output", recursive = TRUE)
dir.create("output", showWarnings = FALSE)
dir.create("temp", showWarnings = FALSE)

dir.create(dir.analysis, showWarnings = FALSE)

```




# Globale Variablen


## Packages definieren

```{targets global-packages, tar_globals = TRUE}

tar_option_set(packages = c("tarchetypes",
                            "RcppTOML",     # TOML-Dateien lesen und schreiben
                            "fs",           # Verbessertes File Handling
                            "zip",          # Verbessertes ZIP Handling
                            "mgsub",        # Vektorisiertes Gsub
                            "httr",         # HTTP-Werkzeuge
                            "rvest",        # HTML/XML-Extraktion
                            "knitr",        # Professionelles Reporting
                            "kableExtra",   # Verbesserte Kable Tabellen
                            "pdftools",     # Verarbeitung von PDF-Dateien
                            "ggplot2",      # Fortgeschrittene Datenvisualisierung
                            "scales",       # Skalierung von Diagrammen
                            "data.table",   # Fortgeschrittene Datenverarbeitung
                            "readtext",     # TXT-Dateien einlesen
                            "quanteda",     # Fortgeschrittene Computerlinguistik
                            "future",       # Parallelisierung
                            "future.apply"))# Funktionen höherer Ordnung für Parallelisierung


```


## Konfiguration


```{targets global-config, tar_globals = TRUE}

datestamp <- Sys.Date()

config <- RcppTOML::parseTOML("CE-BPatG_Config.toml")

dir.analysis <- paste0(getwd(),
                       "/analysis")

## Caption for diagrams
caption <- paste("Fobbe | DOI:",
                 config$doi$data$version)


## Prefix for figure titles
prefix.figuretitle <- paste(config$project$shortname,
                            "| Version",
                            datestamp)

## File prefix
prefix.files <- paste0(config$project$shortname,
                       "_",
                       datestamp)


if (config$cores$max == TRUE){
    fullCores <- future::availableCores()
}


if (config$cores$max == FALSE){
    fullCores <- as.integer(config$cores$number)
}

message(paste("Parallel processing: using", fullCores, "cores.")) 


```




## Funktionen definieren

```{targets global-functions, tar_globals = TRUE}

lapply(list.files("functions", full.names = TRUE), source)

source("R-fobbe-proto-package/f.linkextract.R")
source("R-fobbe-proto-package/f.year.iso.R")
source("R-fobbe-proto-package/f.hyphen.remove.R")
source("R-fobbe-proto-package/f.fast.freqtable.R")
source("R-fobbe-proto-package/f.future_lingsummarize.R")
source("R-fobbe-proto-package/f.future_multihashes.R")

```



## Metadaten für TXT-Dateien definieren

```{targets global-txtvars, tar_globals = TRUE}

docvarnames <- c("gericht",
                 "senatsgruppe",
                 "leitsatz",
                 "datum",
                 "spruchkoerper_az",
                 "registerzeichen",
                 "eingangsnummer",
                 "eingangsjahr_az",
                 "zusatz_az",
                 "kollision")

```


## ZIP-Datei für Source definieren

```{targets global-sourcefiles, tar_globals = TRUE}

files.source.raw <-  c(list.files(pattern = "\\.R$|\\.toml$|\\.md$|\\.Rmd$"),
                       "R-fobbe-proto-package",
                       "data",
                       "functions",
                       "tex",
                       "gpg",
                       "buttons",
                       list.files(pattern = "renv\\.lock|\\.Rprofile",
                                  all.files = TRUE),
                       list.files("renv",
                                  pattern = "activate\\.R",
                                  full.names = TRUE))

```






# Pipeline: Konstruktion



## Data Targets


```{targets tar.data}

list(tar_target(file.scope,
                "data/CE-BPatG_Scope.csv",
                format = "file"),
     tar_target(scope,
                fread(file.scope)),
     tar_target(file.variables,
                "data/CE-BPatG_Variables.csv",
                format = "file"),
     tar_target(variables,
                fread(file.variables)),
     tar_target(file.az.brd,
                "data/AZ-BRD_1-0-1_DE_Registerzeichen_Datensatz.csv",
                format = "file"),
     tar_target(az.brd,
                fread(file.az.brd)),
     tar_target(files.source,
                files.source.raw,
                format = "file"),
     tar_target(changelog,
                "CHANGELOG.md",
                format = "file")
     )

```




## Download Targets

```{targets tar.download}

list(tar_target(dt.download,
                f.download_table_make(x = scope,
                                      debug.toggle = config$debug$toggle,
                                      debug.pages = config$debug$pages)),
     tar_target(az_clean,
                f.clean_az_bpatg(dt.download$az)),
     tar_target(senatsgruppe_clean,
                f.clean_spruch_bpatg(dt.download$spruch)),
     tar_target(dt.download.final,
                f.download_table_finalize(x = dt.download,
                                          az = az_clean,
                                          senatsgruppe = senatsgruppe_clean)),
     tar_target(files.pdf,
                f.download(url = dt.download.final$url,
                           filename = dt.download.final$doc_id,
                           dir = "pdf",
                           sleep.min = 0,
                           sleep.max = 0.1,
                           retries = 3,
                           retry.sleep.min = 2,
                           retry.sleep.max = 5,
                           timeout = config$download$timeout,
                           debug.toggle = FALSE,
                           debug.files = 500),
                format = "file")
     )

```

### Convert Targets

```{targets tar.convert}

list(tar_target(files.txt,
                f.pdf_extract_targets(files.pdf),
                format = "file"),
     tar_target(dt.bpatg,
                f.readtext(x = files.txt,
                           docvarnames = docvarnames))
     )
					
```					

### Enhance Targets


```{targets tar.enhance}


list(tar_target(dt.bpatg.datecleaned,
                f.clean_dates(dt.bpatg)),
     tar_target(var_verfahrensart,
                f.var_verfahrensart(dt.bpatg.datecleaned$registerzeichen,
                                    az.brd = az.brd,
                                    gericht = "BPatG")),
     tar_target(var_aktenzeichen,
                f.var_aktenzeichen(dt.bpatg.datecleaned,
                                   az.brd = az.brd,
                                   gericht = "BPatG")),
     tar_target(var_entscheidung_typ,
                f.var_entscheidung_typ_bpatg(dt.bpatg.datecleaned$text)),
     tar_target(var_ecli,
                f.var_ecli_bpatg(dt.bpatg.datecleaned,
                                 entscheidung_typ = var_entscheidung_typ)),
     tar_target(var_lingstats,
                f.lingstats(dt.bpatg.datecleaned,
                            multicore = config$parallel$lingsummarize,
                            cores = fullCores,
                            germanvars = TRUE)),
     tar_target(var_constants,
                data.frame(version = as.character(datestamp),
                           doi_concept = config$doi$data$concept,
                           doi_version = config$doi$data$version,
                           lizenz = as.character(config$license$data))[rep(1,
                                                                           nrow(dt.bpatg.datecleaned)),]),
     tar_target(dt.bpatg.full,
                f.dataset_finalize(dt.bpatg.datecleaned,
                                   download.table = dt.download.final,
                                   aktenzeichen = var_aktenzeichen,
                                   ecli = var_ecli,
                                   entscheidung_typ = var_entscheidung_typ,
                                   verfahrensart = var_verfahrensart,
                                   lingstats = var_lingstats,
                                   constants = var_constants,
                                   variablen = variables$variable)),
     tar_target(dt.bpatg.meta,
                dt.bpatg.full[, !"text"])
     )

```

### Write Targets



```{targets tar.write}

list(tar_target(csv.full,
                f.tar_fwrite(x = dt.bpatg.full,
                             filename = file.path("output",
                                                  paste0(prefix.files,
                                                         "_DE_CSV_Datensatz.csv"))
                             )
                ),
     
     tar_target(csv.meta,
                f.tar_fwrite(x = dt.bpatg.meta,
                             filename = file.path("output",
                                                  paste0(prefix.files,
                                                         "_DE_CSV_Metadaten.csv"))
                             )
                ),
     tar_target(csv.hashes,
                f.tar_fwrite(x = hashes,
                             filename = file.path("output",
                                                  paste0(prefix.files,
                                                         "_DE_KryptographischeHashes.csv"))
                             )
                )
     )

```

### Zip Targets


```{targets tar.zip}

list(tar_target(zip.pdf.all,
                f.zip_targets(files.pdf,
                              filename = paste(prefix.files,
                                               "DE_PDF_Datensatz.zip",
                                               sep = "_"),
                              dir = "output",
                              mode = "cherry-pick"),
                format = "file"),

     tar_target(zip.pdf.leitsatz,
                f.zip_targets(grep("_LE_", files.pdf, value = TRUE),
                              filename = paste(prefix.files,
                                               "DE_PDF_Leitsatz-Entscheidungen.zip",
                                               sep = "_"),
                              dir = "output",
                              mode = "cherry-pick"),
                format = "file"),
     
     tar_target(zip.txt,
                f.zip_targets(files.txt,
                              filename = paste(prefix.files,
                                               "DE_TXT_Datensatz.zip",
                                               sep = "_"),
                              dir = "output",
                              mode = "cherry-pick"),
                format = "file"),
     
     tar_target(zip.csv.full,
                f.zip_targets(csv.full,
                              filename = gsub("\\.csv", "\\.zip", basename(csv.full)),
                              dir = "output",
                              mode = "cherry-pick"),
                format = "file"),
     tar_target(zip.csv.meta,
                f.zip_targets(csv.meta,
                              filename = gsub("\\.csv", "\\.zip", basename(csv.meta)),
                              dir = "output",
                              mode = "cherry-pick"),
                format = "file"),

     tar_target(zip.source,
                f.zip_targets(files.source,
                              filename = paste0(prefix.files,
                                                "_Source_Code.zip"),
                              dir = "output",
                              mode = "mirror"),
                format = "file"),
     tar_target(zip.all,
                c(zip.pdf.all,
                  zip.pdf.leitsatz,
                  zip.txt,
                  zip.csv.full,
                  zip.csv.meta,
                  zip.source)),
     tar_target(hashes,
                f.tar_multihashes(zip.all,
                                  multicore = config$parallel$lingsummarize,
                                  cores = fullCores))
     )

```


### Report Targets



```{targets tar.report}


list(tar_target(latexdefs,
                f.latexdefs(config,
                            dir = "temp",
                            datestamp = datestamp)),
     tar_target(lingstats.summary,
                f.lingstats_summary(dt.bpatg.full,
                                    germanvars = TRUE)),
     tarchetypes::tar_render(report.tests,
                             file.path("reports",
                                       "CE-BPatG_Testreport.Rmd")),
     tarchetypes::tar_render(report.codebook,
                             file.path("reports",
                                       "CE-BPatG_Codebook.Rmd"))
     )


```




# Pipeline: Kompilierung


```{r, results = "hide"}
tar_make()
```


# Pipeline: Analyse


## Gesamte Liste

```{r, pipeline-list}

meta <- tar_meta(fields = c("type", "bytes"), complete_only = TRUE)
setDT(meta)

kable(meta[order(type, name)],
      format = "latex",
      align = "r",
      booktabs = TRUE,
      longtable = TRUE) %>% kable_styling(latex_options = "repeat_header")


```

\newpage
## Timing


```{r, pipeline-timing}

meta <- tar_meta(fields = c("time", "seconds"), complete_only = TRUE)
setDT(meta)

kable(meta[order(-seconds)],
      format = "latex",
      align = "r",
      booktabs = TRUE,
      longtable = TRUE) %>% kable_styling(latex_options = "repeat_header")


```


\newpage
## Warnungen


```{r, pipeling-warnings}

meta <- tar_meta(fields = "warnings", complete_only = TRUE)
setDT(meta)

kable(meta,
      format = "latex",
      align = "r",
      booktabs = TRUE,
      longtable = TRUE) %>% kable_styling(latex_options = "repeat_header")


```


\newpage
## Fehlermeldungen

```{r, pipeline-errors}

meta <- tar_meta(fields = "error", complete_only = TRUE)
setDT(meta)

kable(meta,
      format = "latex",
      align = "r",
      booktabs = TRUE,
      longtable = TRUE) %>% kable_styling(latex_options = "repeat_header")


```


\newpage
## Netzwerk

```{r, pipeline-graph, width = 9, height = 9}

edgelist <- tar_network(targets_only = TRUE)$edges
setDT(edgelist)

g  <- igraph::graph.data.frame(edgelist,
                               directed = TRUE)


ggraph(g,
       'dh') + 
    geom_edge_diagonal(colour = "grey")+
    geom_node_point()+
    geom_node_text(aes(label = name),
                   size = 2,
                   repel = TRUE)+
    theme_void()

```
                       
